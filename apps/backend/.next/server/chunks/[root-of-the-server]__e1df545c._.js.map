{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 61, "column": 0}, "map": {"version":3,"sources":["file:///Users/vishnuadithya/Documents/xeno/shopify-mt/apps/backend/src/lib/env.ts"],"sourcesContent":["import { z } from 'zod';\n\nconst envSchema = z.object({\n  NODE_ENV: z.enum(['development', 'test', 'production']).default('development'),\n  DATABASE_URL: z.string().url(),\n  SHOPIFY_API_KEY: z.string().min(1),\n  SHOPIFY_API_SECRET: z.string().min(1),\n  SHOPIFY_SCOPES: z.string().min(1),\n  SHOPIFY_APP_URL: z.string().url(),\n  SHOPIFY_REDIRECT_PATH: z.string().default('/api/oauth/callback'),\n  // Email configuration (optional for development)\n  EMAIL_SERVER_HOST: z.string().optional(),\n  EMAIL_SERVER_PORT: z.string().optional(),\n  EMAIL_SERVER_USER: z.string().optional(),\n  EMAIL_SERVER_PASSWORD: z.string().optional(),\n  EMAIL_FROM: z.string().optional(),\n  NEXTAUTH_SECRET: z.string().optional(),\n  NEXTAUTH_URL: z.string().url().optional(),\n});\n\nexport type Env = z.infer<typeof envSchema>;\n\nlet cachedEnv: Env | null = null;\n\nexport function getEnv(): Env {\n  if (cachedEnv) return cachedEnv;\n  const parsed = envSchema.safeParse({\n    NODE_ENV: process.env.NODE_ENV,\n    DATABASE_URL: process.env.DATABASE_URL,\n    SHOPIFY_API_KEY: process.env.SHOPIFY_API_KEY,\n    SHOPIFY_API_SECRET: process.env.SHOPIFY_API_SECRET,\n    SHOPIFY_SCOPES: process.env.SHOPIFY_SCOPES,\n    SHOPIFY_APP_URL: process.env.SHOPIFY_APP_URL,\n    SHOPIFY_REDIRECT_PATH: process.env.SHOPIFY_REDIRECT_PATH,\n    EMAIL_SERVER_HOST: process.env.EMAIL_SERVER_HOST,\n    EMAIL_SERVER_PORT: process.env.EMAIL_SERVER_PORT,\n    EMAIL_SERVER_USER: process.env.EMAIL_SERVER_USER,\n    EMAIL_SERVER_PASSWORD: process.env.EMAIL_SERVER_PASSWORD,\n    EMAIL_FROM: process.env.EMAIL_FROM,\n    NEXTAUTH_SECRET: process.env.NEXTAUTH_SECRET,\n    NEXTAUTH_URL: process.env.NEXTAUTH_URL,\n  });\n  if (!parsed.success) {\n    console.error('Invalid environment variables', parsed.error.flatten().fieldErrors);\n    throw new Error('Invalid environment variables');\n  }\n  cachedEnv = parsed.data;\n  return cachedEnv;\n}\n\n\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,YAAY,0QAAC,CAAC,MAAM,CAAC;IACzB,UAAU,0QAAC,CAAC,IAAI,CAAC;QAAC;QAAe;QAAQ;KAAa,EAAE,OAAO,CAAC;IAChE,cAAc,0QAAC,CAAC,MAAM,GAAG,GAAG;IAC5B,iBAAiB,0QAAC,CAAC,MAAM,GAAG,GAAG,CAAC;IAChC,oBAAoB,0QAAC,CAAC,MAAM,GAAG,GAAG,CAAC;IACnC,gBAAgB,0QAAC,CAAC,MAAM,GAAG,GAAG,CAAC;IAC/B,iBAAiB,0QAAC,CAAC,MAAM,GAAG,GAAG;IAC/B,uBAAuB,0QAAC,CAAC,MAAM,GAAG,OAAO,CAAC;IAC1C,iDAAiD;IACjD,mBAAmB,0QAAC,CAAC,MAAM,GAAG,QAAQ;IACtC,mBAAmB,0QAAC,CAAC,MAAM,GAAG,QAAQ;IACtC,mBAAmB,0QAAC,CAAC,MAAM,GAAG,QAAQ;IACtC,uBAAuB,0QAAC,CAAC,MAAM,GAAG,QAAQ;IAC1C,YAAY,0QAAC,CAAC,MAAM,GAAG,QAAQ;IAC/B,iBAAiB,0QAAC,CAAC,MAAM,GAAG,QAAQ;IACpC,cAAc,0QAAC,CAAC,MAAM,GAAG,GAAG,GAAG,QAAQ;AACzC;AAIA,IAAI,YAAwB;AAErB,SAAS;IACd,IAAI,WAAW,OAAO;IACtB,MAAM,SAAS,UAAU,SAAS,CAAC;QACjC,QAAQ;QACR,cAAc,QAAQ,GAAG,CAAC,YAAY;QACtC,iBAAiB,QAAQ,GAAG,CAAC,eAAe;QAC5C,oBAAoB,QAAQ,GAAG,CAAC,kBAAkB;QAClD,gBAAgB,QAAQ,GAAG,CAAC,cAAc;QAC1C,iBAAiB,QAAQ,GAAG,CAAC,eAAe;QAC5C,uBAAuB,QAAQ,GAAG,CAAC,qBAAqB;QACxD,mBAAmB,QAAQ,GAAG,CAAC,iBAAiB;QAChD,mBAAmB,QAAQ,GAAG,CAAC,iBAAiB;QAChD,mBAAmB,QAAQ,GAAG,CAAC,iBAAiB;QAChD,uBAAuB,QAAQ,GAAG,CAAC,qBAAqB;QACxD,YAAY,QAAQ,GAAG,CAAC,UAAU;QAClC,iBAAiB,QAAQ,GAAG,CAAC,eAAe;QAC5C,cAAc,QAAQ,GAAG,CAAC,YAAY;IACxC;IACA,IAAI,CAAC,OAAO,OAAO,EAAE;QACnB,QAAQ,KAAK,CAAC,iCAAiC,OAAO,KAAK,CAAC,OAAO,GAAG,WAAW;QACjF,MAAM,IAAI,MAAM;IAClB;IACA,YAAY,OAAO,IAAI;IACvB,OAAO;AACT","debugId":null}},
    {"offset": {"line": 118, "column": 0}, "map": {"version":3,"sources":["file:///Users/vishnuadithya/Documents/xeno/shopify-mt/apps/backend/src/lib/db.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client';\nimport { getEnv } from './env';\n\ndeclare global {\n  var prisma: PrismaClient | undefined;\n}\n\nexport function getPrisma(): PrismaClient {\n  // Ensure env parsed (side-effect to validate early)\n  getEnv();\n  if (global.prisma) return global.prisma;\n  const client = new PrismaClient({\n    log: process.env.NODE_ENV === 'development' ? ['query', 'error', 'warn'] : ['error']\n  });\n  global.prisma = client;\n  return client;\n}\n\n\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAMO,SAAS;IACd,oDAAoD;IACpD,IAAA,sLAAM;IACN,IAAI,OAAO,MAAM,EAAE,OAAO,OAAO,MAAM;IACvC,MAAM,SAAS,IAAI,6IAAY,CAAC;QAC9B,KAAK,uCAAyC;YAAC;YAAS;YAAS;SAAO,GAAG;IAC7E;IACA,OAAO,MAAM,GAAG;IAChB,OAAO;AACT","debugId":null}},
    {"offset": {"line": 144, "column": 0}, "map": {"version":3,"sources":["file:///Users/vishnuadithya/Documents/xeno/shopify-mt/apps/backend/src/lib/shopify-admin.ts"],"sourcesContent":["// Small helper to call Admin GraphQL using the accessToken stored in your DB.\nimport { getPrisma } from '@/lib/db'\n\nfunction envTokenForShop(shop: string): string | undefined {\n  const base = shop.toUpperCase().replace(/[^A-Z0-9]/g, '_')\n  const byShop = process.env[`SHOPIFY_TOKEN_${base}`]\n  return byShop || process.env.SHOPIFY_ACCESS_TOKEN\n}\n\nexport async function adminFetch(shop: string, query: string, variables?: any) {\n  let token: string | undefined\n\n  // Try DB first, but tolerate DB outages and fall back to env\n  try {\n    const prisma = getPrisma()\n    const store = await prisma.store.findFirst({ where: { shopDomain: shop } })\n    token = store?.accessToken\n  } catch (_e) {\n    // ignore and try env\n  }\n\n  if (!token) token = envTokenForShop(shop)\n  if (!token) throw new Error(`Missing access token for store ${shop}. Provide in DB or env (SHOPIFY_TOKEN_${shop.toUpperCase().replace(/[^A-Z0-9]/g, '_')} or SHOPIFY_ACCESS_TOKEN).`)\n\n  const res = await fetch(`https://${shop}/admin/api/2024-10/graphql.json`, {\n    method: \"POST\",\n    headers: {\n      \"Content-Type\": \"application/json\",\n      \"X-Shopify-Access-Token\": token,\n    },\n    body: JSON.stringify({ query, variables }),\n    cache: \"no-store\",\n  })\n  const json = await res.json()\n  if (!res.ok || json.errors) {\n    throw new Error(JSON.stringify(json.errors ?? json))\n  }\n  return json.data\n}\n"],"names":[],"mappings":"AAAA,8EAA8E;;;;;AAC9E;;AAEA,SAAS,gBAAgB,IAAY;IACnC,MAAM,OAAO,KAAK,WAAW,GAAG,OAAO,CAAC,cAAc;IACtD,MAAM,SAAS,QAAQ,GAAG,CAAC,CAAC,cAAc,EAAE,MAAM,CAAC;IACnD,OAAO,UAAU,QAAQ,GAAG,CAAC,oBAAoB;AACnD;AAEO,eAAe,WAAW,IAAY,EAAE,KAAa,EAAE,SAAe;IAC3E,IAAI;IAEJ,6DAA6D;IAC7D,IAAI;QACF,MAAM,SAAS,IAAA,wLAAS;QACxB,MAAM,QAAQ,MAAM,OAAO,KAAK,CAAC,SAAS,CAAC;YAAE,OAAO;gBAAE,YAAY;YAAK;QAAE;QACzE,QAAQ,OAAO;IACjB,EAAE,OAAO,IAAI;IACX,qBAAqB;IACvB;IAEA,IAAI,CAAC,OAAO,QAAQ,gBAAgB;IACpC,IAAI,CAAC,OAAO,MAAM,IAAI,MAAM,CAAC,+BAA+B,EAAE,KAAK,sCAAsC,EAAE,KAAK,WAAW,GAAG,OAAO,CAAC,cAAc,KAAK,0BAA0B,CAAC;IAEpL,MAAM,MAAM,MAAM,MAAM,CAAC,QAAQ,EAAE,KAAK,+BAA+B,CAAC,EAAE;QACxE,QAAQ;QACR,SAAS;YACP,gBAAgB;YAChB,0BAA0B;QAC5B;QACA,MAAM,KAAK,SAAS,CAAC;YAAE;YAAO;QAAU;QACxC,OAAO;IACT;IACA,MAAM,OAAO,MAAM,IAAI,IAAI;IAC3B,IAAI,CAAC,IAAI,EAAE,IAAI,KAAK,MAAM,EAAE;QAC1B,MAAM,IAAI,MAAM,KAAK,SAAS,CAAC,KAAK,MAAM,IAAI;IAChD;IACA,OAAO,KAAK,IAAI;AAClB","debugId":null}},
    {"offset": {"line": 194, "column": 0}, "map": {"version":3,"sources":["file:///Users/vishnuadithya/Documents/xeno/shopify-mt/apps/backend/src/app/api/analytics/top-customers/route.ts"],"sourcesContent":["// src/app/api/analytics/top-customers/route.ts - Real Shopify API Integration\nimport { NextRequest, NextResponse } from \"next/server\";\nimport { adminFetch } from \"@/lib/shopify-admin\";\n\nexport const runtime = \"nodejs\";\n\nconst TOP_CUSTOMERS_QUERY = `\n  query TopCustomers($ordersQuery: String!, $first: Int!) {\n    orders(first: $first, query: $ordersQuery, sortKey: CREATED_AT, reverse: false) {\n      edges {\n        node {\n          id\n          createdAt\n          totalPriceSet { shopMoney { amount } }\n          customer {\n            id\n            firstName\n            lastName\n            email\n            createdAt\n          }\n        }\n      }\n    }\n  }\n`;\n\nexport async function GET(req: NextRequest) {\n  try {\n    const { searchParams } = new URL(req.url);\n    const shop = searchParams.get(\"shop\");\n    if (!shop) return NextResponse.json({ error: \"Missing shop\" }, { status: 400 });\n\n    const end = searchParams.get(\"endDate\") ?? new Date().toISOString().slice(0, 10);\n    const start = searchParams.get(\"startDate\") ?? \n      new Date(Date.now() - 30 * 86400000).toISOString().slice(0, 10);\n\n    const limit = Number(searchParams.get(\"limit\") ?? 10);\n\n    const ordersQuery = `created_at:>=${start} created_at:<=${end}`;\n\n    // Fetch orders with customer data from Shopify Admin GraphQL\n    const data = await adminFetch(shop, TOP_CUSTOMERS_QUERY, {\n      ordersQuery,\n      first: 250\n    });\n\n    const orders = data.orders.edges.map((e: any) => e.node).filter((order: any) => order.customer);\n\n    // Aggregate customer data\n    const customerAgg = new Map<string, {\n      customerId: string;\n      fullName: string;\n      email: string;\n      totalSpend: number;\n      orderCount: number;\n      avgOrderValue: number;\n      customerSince: string;\n      daysSinceLastOrder: number;\n    }>();\n\n    for (const order of orders) {\n      if (!order.customer) continue;\n      \n      const customerId = order.customer.id;\n      const orderValue = parseFloat(order.totalPriceSet?.shopMoney?.amount || '0');\n      const orderDate = new Date(order.createdAt);\n      \n      const existing = customerAgg.get(customerId) ?? {\n        customerId,\n        fullName: `${order.customer.firstName || ''} ${order.customer.lastName || ''}`.trim() || 'Unknown Customer',\n        email: order.customer.email || 'No email',\n        totalSpend: 0,\n        orderCount: 0,\n        avgOrderValue: 0,\n        customerSince: order.customer.createdAt ? \n          new Date(order.customer.createdAt).toLocaleDateString('en-IN') : 'Unknown',\n        daysSinceLastOrder: 0,\n      };\n      \n      existing.totalSpend += orderValue;\n      existing.orderCount += 1;\n      \n      // Calculate days since last order (using this order as reference)\n      existing.daysSinceLastOrder = Math.floor((Date.now() - orderDate.getTime()) / (1000 * 60 * 60 * 24));\n      \n      customerAgg.set(customerId, existing);\n    }\n\n    // Calculate AOV and sort by total spend\n    const topCustomers = Array.from(customerAgg.values())\n      .map(customer => ({\n        ...customer,\n        avgOrderValue: Math.round((customer.totalSpend / customer.orderCount) * 100) / 100,\n        totalSpend: Math.round(customer.totalSpend * 100) / 100,\n      }))\n      .sort((a, b) => b.totalSpend - a.totalSpend)\n      .slice(0, limit);\n\n    // Customer segments analysis\n    const allCustomersData = Array.from(customerAgg.values());\n    const segments = {\n      vip: allCustomersData.filter(c => c.totalSpend >= 25000).length,\n      regular: allCustomersData.filter(c => c.totalSpend >= 5000 && c.totalSpend < 25000).length,\n      casual: allCustomersData.filter(c => c.totalSpend < 5000).length,\n    };\n\n    const totalRevenue = allCustomersData.reduce((sum, c) => sum + c.totalSpend, 0);\n\n    return NextResponse.json({ \n      shop, \n      window: { start, end }, \n      top: topCustomers,\n      summary: {\n        totalCustomersWithOrders: allCustomersData.length,\n        totalUniqueCustomers: allCustomersData.length,\n        segments,\n        avgCustomerValue: allCustomersData.length > 0 ? \n          Math.round((totalRevenue / allCustomersData.length) * 100) / 100 : 0,\n      }\n    });\n  } catch (err: any) {\n    console.error('Shopify Top customers error:', err);\n    return NextResponse.json({ error: err.message ?? \"Unknown error\" }, { status: 500 });\n  }\n}"],"names":[],"mappings":"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","debugId":null}}]
}